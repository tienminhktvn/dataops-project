# =============================================================================
# CD WORKFLOW: Deployment
# =============================================================================
name: CD - Deploy Pipeline

on:
  push:
    branches:
      - main
      - develop
    paths:
      - dbt/**
      - airflow/**
      - docker-compose.yaml
      - .github/workflows/cd-deploy.yml
  workflow_dispatch:
    inputs:
      environment:
        description: Target environment
        required: true
        default: dev
        type: choice
        options: [dev, prod]

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # ===========================================================================
  # Determine Environment & Target
  # ===========================================================================
  determine-env:
    name: Setup Environment
    runs-on: self-hosted
    outputs:
      env_name: ${{ steps.set-env.outputs.env_name }}
      dbt_target: ${{ steps.set-env.outputs.dbt_target }}
    steps:
      - name: Resolve Environment
        id: set-env
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            ENV="${{ github.event.inputs.environment }}"
          elif [ "${{ github.ref }}" == "refs/heads/main" ]; then
            ENV="prod"
          else
            ENV="dev"
          fi

          echo "env_name=$ENV" >> $GITHUB_OUTPUT
          echo "dbt_target=$ENV" >> $GITHUB_OUTPUT

          echo "üéØ Deployment Goal: $ENV Environment"

  # ===========================================================================
  # Deploy
  # ===========================================================================
  deploy-and-test:
    name: Deploy & Validate
    runs-on: self-hosted
    needs: [determine-env]
    env:
      TARGET: ${{ needs.determine-env.outputs.dbt_target }}

    steps:
      # -----------------------------------------------------------------------
      # Cleanup & Prepare
      # -----------------------------------------------------------------------
      - name: Clean Workspace
        run: |
          echo "üßπ Force cleaning workspace..."

          # Force stop and remove all containers
          docker compose down --remove-orphans 2>/dev/null || true
          docker stop $(docker ps -aq) 2>/dev/null || true

          # Wait for containers to fully stop
          echo "‚è≥ Waiting 5s for containers to stop..."
          sleep 5

          # Kill any remaining DBT/Python processes
          pkill -9 dbt 2>/dev/null || true
          pkill -9 python 2>/dev/null || true

          # Force remove directories with sudo
          echo "üóëÔ∏è Removing old files..."
          for dir in dbt/dbt_packages dbt/target dbt/logs airflow/logs; do
            if [ -d "$dir" ]; then
              echo "  Removing $dir"
              sudo chmod -R 777 "$dir" 2>/dev/null || true
              sudo rm -rf "$dir" 2>/dev/null || true
            fi
          done

          # Recreate necessary directories
          mkdir -p dbt/logs airflow/logs
          sudo chmod 777 dbt/logs airflow/logs

          echo "‚úÖ Workspace cleaned"

      # -----------------------------------------------------------------------
      # Code Update
      # -----------------------------------------------------------------------
      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          clean: true

      - name: Create Backup Metadata
        if: needs.determine-env.outputs.env_name == 'prod'
        run: |
          mkdir -p backup
          echo "Backup for commit ${{ github.sha }}" > backup/deploy_meta_${{ github.sha }}.txt

      # -----------------------------------------------------------------------
      # Update Infrastructure
      # -----------------------------------------------------------------------
      - name: Restart Containers
        run: |
          echo "üõë Stopping containers to release file locks..."
          docker compose down || true

          echo "üîß Fixing permissions..."
          mkdir -p airflow/logs airflow/plugins airflow/dags

          docker run --rm \
            -v $PWD/airflow:/opt/airflow \
            alpine sh -c "chmod -R 777 /opt/airflow/logs /opt/airflow/plugins /opt/airflow/dags"

          echo "üîÑ Rebuilding and restarting containers..."
          docker compose up -d --build

      - name: Wait for Health
        run: |
          echo "‚è≥ Waiting 40s for services to stabilize..."
          sleep 40

      # -----------------------------------------------------------------------
      # Execute Pipeline
      # -----------------------------------------------------------------------
      - name: Run Models
        run: |
          echo "üöÄ Running DBT Models (Target: $TARGET)..."
          docker exec dataops-dbt dbt run --target $TARGET --full-refresh

      - name: Run Tests
        run: |
          echo "üß™ Running Tests..."
          docker exec dataops-dbt dbt test --target $TARGET

      # -----------------------------------------------------------------------
      # Artifact Collection
      # -----------------------------------------------------------------------
      - name: Extract Artifacts
        if: always()
        run: |
          mkdir -p deployment_artifacts
          docker cp dataops-dbt:/usr/app/dbt/target/run_results.json ./deployment_artifacts/
          docker cp dataops-dbt:/usr/app/dbt/target/index.html ./deployment_artifacts/

      - name: Upload Logs to GitHub
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: deployment-logs-${{ needs.determine-env.outputs.env_name }}
          path: deployment_artifacts/
          retention-days: 30

  # ===========================================================================
  # Notification
  # ===========================================================================
  notify:
    name: Final Status
    runs-on: self-hosted
    needs: [determine-env, deploy-and-test]
    if: always()
    steps:
      - name: Send Slack Notification
        if: always()
        run: |
          # Define Status Variables
          STATUS="${{ needs.deploy-and-test.result }}"
          ENV="${{ needs.determine-env.outputs.env_name }}"
          REPO="${{ github.repository }}"
          COMMIT_SHA="${{ github.sha }}"
          SHORT_SHA=$(echo $COMMIT_SHA | cut -c1-7)
          RUN_ID="${{ github.run_id }}"
          ACTOR="${{ github.actor }}"

          # Set Colors and Titles based on success/failure
          if [ "$STATUS" == "success" ]; then
            COLOR="#2EB67D"  # Green
            HEADER="üöÄ Deployment Successful"
            MSG="The data pipeline has been successfully deployed and verified."
          else
            COLOR="#FF0000"  # Red
            HEADER="üö® Deployment Failed"
            MSG="The deployment encountered errors. Please check the logs immediately."
          fi

          # Construct JSON Payload
          PAYLOAD=$(cat <<EOF
          {
            "attachments": [
              {
                "color": "$COLOR",
                "blocks": [
                  {
                    "type": "header",
                    "text": {
                      "type": "plain_text",
                      "text": "$HEADER",
                      "emoji": true
                    }
                  },
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": "$MSG"
                    }
                  },
                  {
                    "type": "section",
                    "fields": [
                      {
                        "type": "mrkdwn",
                        "text": "*Environment:*\n$ENV"
                      },
                      {
                        "type": "mrkdwn",
                        "text": "*Status:*\n$STATUS"
                      },
                      {
                        "type": "mrkdwn",
                        "text": "*Deployer:*\n$ACTOR"
                      },
                      {
                        "type": "mrkdwn",
                        "text": "*Commit:*\n<https://github.com/$REPO/commit/$COMMIT_SHA|$SHORT_SHA>"
                      }
                    ]
                  },
                  {
                    "type": "actions",
                    "elements": [
                      {
                        "type": "button",
                        "text": {
                          "type": "plain_text",
                          "text": "View Action Logs"
                        },
                        "style": "primary",
                        "url": "https://github.com/$REPO/actions/runs/$RUN_ID"
                      }
                    ]
                  }
                ]
              }
            ]
          }
          EOF
          )

          curl -X POST -H 'Content-type: application/json' --data "$PAYLOAD" ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Generate GitHub Summary
        run: |
          if [ "${{ needs.deploy-and-test.result }}" == "success" ]; then
            echo "# ‚úÖ Deployment Successful" >> $GITHUB_STEP_SUMMARY
            echo "Deployed to **${{ needs.determine-env.outputs.env_name }}**" >> $GITHUB_STEP_SUMMARY
          else
            echo "# ‚ùå Deployment Failed" >> $GITHUB_STEP_SUMMARY
            echo "Check Slack or Logs for details." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

  # ===========================================================================
  # Post-Deployment Cleanup
  # ===========================================================================
  cleanup:
    name: Cleanup
    runs-on: self-hosted
    needs: [deploy-and-test]
    if: always()
    steps:
      - name: Fix Permissions
        run: |
          echo "üßπ Fixing permissions for next run..."
          if [ -d "dbt/dbt_packages" ]; then
            sudo chmod -R 777 dbt/dbt_packages || true
          fi
          if [ -d "dbt/target" ]; then
            sudo chmod -R 777 dbt/target || true
          fi
          if [ -d "dbt/logs" ]; then
            sudo chmod -R 777 dbt/logs || true
          fi
          echo "‚úÖ Cleanup complete"
