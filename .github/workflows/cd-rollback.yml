# =============================================================================
# CD WORKFLOW: Rollback Deployment (Self-Hosted)
# =============================================================================

name: CD - Rollback Deployment
on:
  workflow_dispatch:
    inputs:
      environment:
        description: Environment to rollback
        required: true
        type: choice
        options: [dev, prod]
      backup_sha:
        description: Commit SHA to rollback to (leave empty for previous)
        required: false
        type: string
      reason:
        description: Reason for rollback
        required: true
        type: string

jobs:
  # ===========================================================================
  # 1. Validate Rollback Request
  # ===========================================================================
  validate-rollback:
    name: Validate Rollback
    runs-on: self-hosted
    outputs:
      target_sha: ${{ steps.determine-sha.outputs.target_sha }}
      can_rollback: ${{ steps.validate.outputs.can_rollback }}
    steps:
      - name: Pre-Cleanup Python Cache Files
        run: |
          echo "üßπ Removing Python cache files before checkout..."

          # Remove Python cache files that cause permission issues
          sudo find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
          sudo find . -type f -name "*.pyc" -exec rm -f {} + 2>/dev/null || true
          sudo find . -type f -name "*.pyo" -exec rm -f {} + 2>/dev/null || true

          echo "‚úÖ Cache files removed"

      - name: Clean Workspace
        run: |
          echo "üßπ Force cleaning workspace..."

          # Force stop and remove all containers
          docker compose down --remove-orphans 2>/dev/null || true
          docker stop $(docker ps -aq) 2>/dev/null || true

          # Wait for containers to fully stop
          echo "‚è≥ Waiting 5s for containers to stop..."
          sleep 5

          # Kill any remaining DBT/Python processes
          pkill -9 dbt 2>/dev/null || true
          pkill -9 python 2>/dev/null || true

          # Force remove directories with sudo (including all cache)
          echo "üóëÔ∏è Removing old files..."
          for dir in dbt/dbt_packages dbt/target dbt/logs airflow; do
            if [ -d "$dir" ]; then
              echo "  Removing $dir"
              sudo chmod -R 777 "$dir" 2>/dev/null || true
              sudo rm -rf "$dir" 2>/dev/null || true
            fi
          done

          # Recreate necessary directories
          mkdir -p dbt/logs airflow/logs airflow/dags airflow/plugins
          sudo chmod -R 777 dbt airflow

          echo "‚úÖ Workspace cleaned"

      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 50
          clean: false

      - name: Determine target SHA
        id: determine-sha
        run: |
          if [ -n "${{ github.event.inputs.backup_sha }}" ]; then
            TARGET_SHA="${{ github.event.inputs.backup_sha }}"
          else
            # Get the commit BEFORE the current HEAD
            TARGET_SHA=$(git rev-parse HEAD~1)
          fi
          echo "target_sha=$TARGET_SHA" >> $GITHUB_OUTPUT
          echo "üéØ Rollback target: $TARGET_SHA"

      - name: Validate rollback target
        id: validate
        run: |
          TARGET_SHA="${{ steps.determine-sha.outputs.target_sha }}"
          if ! git cat-file -e "$TARGET_SHA^{commit}" 2>/dev/null; then
            echo "‚ùå Invalid commit SHA: $TARGET_SHA"
            echo "can_rollback=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          echo "‚úÖ Rollback target is valid"
          echo "can_rollback=true" >> $GITHUB_OUTPUT

  # ===========================================================================
  # 2. Execute Rollback (Update Containers & Run DBT)
  # ===========================================================================
  execute-rollback:
    name: Execute Rollback
    runs-on: self-hosted
    needs: [validate-rollback]
    if: needs.validate-rollback.outputs.can_rollback == 'true'
    steps:
      - name: Pre-Cleanup Python Cache Files
        run: |
          echo "üßπ Removing Python cache files before checkout..."

          # Remove Python cache files that cause permission issues
          sudo find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
          sudo find . -type f -name "*.pyc" -exec rm -f {} + 2>/dev/null || true
          sudo find . -type f -name "*.pyo" -exec rm -f {} + 2>/dev/null || true

          echo "‚úÖ Cache files removed"

      - name: Clean Workspace
        run: |
          echo "üßπ Force cleaning workspace for rollback..."

          # Force stop and remove all containers
          docker compose down --remove-orphans 2>/dev/null || true
          docker stop $(docker ps -aq) 2>/dev/null || true

          # Wait for containers to fully stop
          echo "‚è≥ Waiting 5s for containers to stop..."
          sleep 5

          # Kill any remaining DBT/Python processes
          pkill -9 dbt 2>/dev/null || true
          pkill -9 python 2>/dev/null || true

          # Force remove directories with sudo (including all cache)
          echo "üóëÔ∏è Removing old files..."
          for dir in dbt/dbt_packages dbt/target dbt/logs airflow; do
            if [ -d "$dir" ]; then
              echo "  Removing $dir"
              sudo chmod -R 777 "$dir" 2>/dev/null || true
              sudo rm -rf "$dir" 2>/dev/null || true
            fi
          done

          # Recreate necessary directories
          mkdir -p dbt/logs airflow/logs airflow/dags airflow/plugins
          sudo chmod -R 777 dbt airflow

          echo "‚úÖ Workspace cleaned"

      - name: Checkout target commit
        uses: actions/checkout@v3
        with:
          ref: ${{ needs.validate-rollback.outputs.target_sha }}
          clean: false

      # Inject Secret for Airflow containers
      - name: Create .env file with Secret
        env:
          WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          echo "SLACK_WEBHOOK_URL=$WEBHOOK_URL" >> .env

      - name: Restart Containers
        run: |
          echo "üõë Stopping containers to release file locks..."
          docker compose down || true

          echo "üîß Fixing permissions..."
          mkdir -p airflow/logs airflow/plugins airflow/dags

          docker run --rm \
            -v $PWD/airflow:/opt/airflow \
            alpine sh -c "chmod -R 777 /opt/airflow/logs /opt/airflow/plugins /opt/airflow/dags"

          echo "üîÑ Rebuilding containers with OLD code..."
          docker compose up -d --build

      - name: Wait for Health
        run: |
          echo "‚è≥ Waiting 30s for services..."
          sleep 30

      - name: Install Dependencies
        run: docker exec dataops-dbt dbt deps

      - name: Deploy Rolled-back Version
        run: |
          echo "üîÑ Deploying rolled-back version..."
          TARGET="${{ github.event.inputs.environment }}"
          # Use --full-refresh to ensure old schema is restored
          docker exec dataops-dbt dbt run --target $TARGET --full-refresh

      - name: Run Verification Tests
        run: |
          echo "üß™ Running verification tests..."
          TARGET="${{ github.event.inputs.environment }}"
          docker exec dataops-dbt dbt test --target $TARGET

  # ===========================================================================
  # 3. Notify Team
  # ===========================================================================
  notify-rollback:
    name: Notify Rollback
    runs-on: self-hosted
    needs: [validate-rollback, execute-rollback]
    if: always()
    steps:
      - name: Send Slack Notification
        run: |
          # 1. Define Variables
          if [ "${{ needs.execute-rollback.result }}" == "success" ]; then
            COLOR="#FF8C00" # Orange (Warning - it is a rollback)
            HEADER="üîÑ Rollback Executed Successfully"
            STATUS="Success"
            MSG="The environment has been rolled back to a previous stable state."
          else
            COLOR="#FF0000" # Red
            HEADER="üö® Rollback Failed"
            STATUS="Failed"
            MSG="The rollback attempt failed. System status is unknown."
          fi

          ENV="${{ github.event.inputs.environment }}"
          TARGET_SHA="${{ needs.validate-rollback.outputs.target_sha }}"
          REASON="${{ github.event.inputs.reason }}"
          ACTOR="${{ github.actor }}"
          REPO="${{ github.repository }}"
          RUN_ID="${{ github.run_id }}"
          SHORT_SHA=$(echo $TARGET_SHA | cut -c1-7)

          # 2. Construct Payload
          PAYLOAD=$(cat <<EOF
          {
            "attachments": [
              {
                "color": "$COLOR",
                "blocks": [
                  {
                    "type": "header",
                    "text": {
                      "type": "plain_text",
                      "text": "$HEADER",
                      "emoji": true
                    }
                  },
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": "$MSG"
                    }
                  },
                  {
                    "type": "section",
                    "fields": [
                      {"type": "mrkdwn", "text": "*Environment:*\n$ENV"},
                      {"type": "mrkdwn", "text": "*Status:*\n$STATUS"},
                      {"type": "mrkdwn", "text": "*Restored Commit:*\n$SHORT_SHA"},
                      {"type": "mrkdwn", "text": "*Executed By:*\n$ACTOR"}
                    ]
                  },
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": "*Reason for Rollback:*\n$REASON"
                    }
                  },
                  {
                    "type": "actions",
                    "elements": [
                      {
                        "type": "button",
                        "text": {"type": "plain_text", "text": "View Rollback Logs"},
                        "style": "danger",
                        "url": "https://github.com/$REPO/actions/runs/$RUN_ID"
                      }
                    ]
                  }
                ]
              }
            ]
          }
          EOF
          )

          # 3. Send Request
          curl -X POST -H 'Content-type: application/json' --data "$PAYLOAD" ${{ secrets.SLACK_WEBHOOK_URL }}

  # ===========================================================================
  # Post-Rollback Cleanup
  # ===========================================================================
  cleanup:
    name: Cleanup
    runs-on: self-hosted
    needs: [execute-rollback]
    if: always()
    steps:
      - name: Fix Permissions
        run: |
          echo "üßπ Fixing permissions for next run..."
          if [ -d "dbt/dbt_packages" ]; then
            sudo chmod -R 777 dbt/dbt_packages || true
          fi
          if [ -d "dbt/target" ]; then
            sudo chmod -R 777 dbt/target || true
          fi
          if [ -d "dbt/logs" ]; then
            sudo chmod -R 777 dbt/logs || true
          fi
          echo "‚úÖ Cleanup complete"
