# =============================================================================
# CD WORKFLOW: Rollback Deployment (Self-Hosted)
# =============================================================================

name: CD - Rollback Deployment
on:
  workflow_dispatch:
    inputs:
      environment:
        description: Environment to rollback
        required: true
        type: choice
        options: [dev, prod]
      backup_sha:
        description: Commit SHA to rollback to (leave empty for previous)
        required: false
        type: string
      reason:
        description: Reason for rollback
        required: true
        type: string

jobs:
  # ===========================================================================
  # Validate Rollback Request
  # ===========================================================================
  validate-rollback:
    name: Validate Rollback
    runs-on: self-hosted
    outputs:
      target_sha: ${{ steps.determine-sha.outputs.target_sha }}
      can_rollback: ${{ steps.validate.outputs.can_rollback }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 50

      - name: Determine target SHA
        id: determine-sha
        run: |
          if [ -n "${{ github.event.inputs.backup_sha }}" ]; then
            TARGET_SHA="${{ github.event.inputs.backup_sha }}"
          else
            # Get the commit BEFORE the current HEAD (HEAD~1)
            TARGET_SHA=$(git rev-parse HEAD~1)
          fi
          echo "target_sha=$TARGET_SHA" >> $GITHUB_OUTPUT
          echo "üéØ Rollback target: $TARGET_SHA"

      - name: Validate rollback target
        id: validate
        run: |
          TARGET_SHA="${{ steps.determine-sha.outputs.target_sha }}"
          if ! git cat-file -e "$TARGET_SHA^{commit}" 2>/dev/null; then
            echo "‚ùå Invalid commit SHA: $TARGET_SHA"
            echo "can_rollback=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          echo "‚úÖ Rollback target is valid"
          echo "can_rollback=true" >> $GITHUB_OUTPUT

  # ===========================================================================
  # Execute Rollback (Update Containers & Run DBT)
  # ===========================================================================
  execute-rollback:
    name: Execute Rollback
    runs-on: self-hosted
    needs: [validate-rollback]
    if: needs.validate-rollback.outputs.can_rollback == 'true'
    steps:
      # 1. Checkout the OLD code
      - name: Checkout target commit
        uses: actions/checkout@v3
        with:
          ref: ${{ needs.validate-rollback.outputs.target_sha }}
          clean: false

      # Update Infrastructure
      - name: Restart Containers
        run: |
          echo "üîÑ Rebuilding containers with OLD code..."
          docker compose up -d --build

      - name: Wait for Health
        run: |
          echo "‚è≥ Waiting 30s for services..."
          sleep 30

      # 3. Run Pipeline
      - name: Install Dependencies
        run: docker exec dataops-dbt dbt deps

      - name: Deploy Rolled-back Version
        run: |
          echo "üîÑ Deploying rolled-back version..."
          TARGET="${{ github.event.inputs.environment }}"
          # Use --full-refresh to ensure old schema is restored
          docker exec dataops-dbt dbt run --target $TARGET --full-refresh

      - name: Run Verification Tests
        run: |
          echo "üß™ Running verification tests..."
          TARGET="${{ github.event.inputs.environment }}"
          docker exec dataops-dbt dbt test --target $TARGET

  # ===========================================================================
  # Notify Team
  # ===========================================================================
  notify-rollback:
    name: Notify Rollback
    runs-on: self-hosted
    needs: [validate-rollback, execute-rollback]
    if: always()
    steps:
      - name: Send Slack Notification
        run: |
          # Define Variables
          if [ "${{ needs.execute-rollback.result }}" == "success" ]; then
            COLOR="#FF8C00" # Orange (Warning - it is a rollback)
            HEADER="üîÑ Rollback Executed Successfully"
            STATUS="Success"
          else
            COLOR="#FF0000" # Red
            HEADER="üö® Rollback Failed"
            STATUS="Failed"
          fi

          ENV="${{ github.event.inputs.environment }}"
          TARGET_SHA="${{ needs.validate-rollback.outputs.target_sha }}"
          REASON="${{ github.event.inputs.reason }}"
          ACTOR="${{ github.actor }}"
          SHORT_SHA=$(echo $TARGET_SHA | cut -c1-7)
